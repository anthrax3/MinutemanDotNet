(function(n,t,i,r){"use strict";function f(){var n=t(arguments).toArray().join("/");return n.length&&n.indexOf("/")===0&&(n=n.substring(1)),"#!/"+n}var u={};u.Router=i.Router.extend({routes:{"!/event-activity/:name/:timeframe":"showEventActivity","!/event-activity/:name":"noTimeframeSelectedForEventActivity","!/event-activity":"showNoEventSelected","!/user-activity/:name/:timeframe":"showUserActivity","!/user-activity/:name":"noTimeframeSelectedForUserActivity","!/user-activity":"showNoEventSelected","":"showNoEventSelected"},showEventActivity:function(n,i){this.removeCurrentView();var r=this.contentElement.empty();u.eventActivityProxy.server.timeframes(n).done(t(function(t){var e=new u.TimeframeList({urlPrefix:"event-activity/"+n,timeframes:t,selectedTimeframe:i}),f=new u.EventActivityGraph({eventName:n,timeframe:i});r.append(e.$el,f.$el),e.render(),f.render(),this.currentView=f}).bind(this))},showUserActivity:function(){this.removeCurrentView()},noTimeframeSelectedForEventActivity:function(n){this.showNoTimeframeSelected("event-activity",n,u.eventActivityProxy,u.eventMenuList,u.userMenuList)},noTimeframeSelectedForUserActivity:function(n){this.showNoTimeframeSelected("user-activity",n,u.userActivityProxy,u.userMenuList,u.eventMenuList)},showNoEventSelected:function(){this.removeCurrentView();var n=this.contentElement.empty(),t=new u.MessageBox({className:"alert-box alert",message:"Select an event from the left menu."});n.append(t.render().$el)},showNoTimeframeSelected:function(n,t,i,r,f){this.removeCurrentView();var e=this.contentElement.empty();i.server.timeframes(t).done(function(i){var o=new u.TimeframeList({urlPrefix:n+"/"+t,timeframes:i}),s=new u.MessageBox({className:"alert-box alert",message:"Select a timeframe from the the above."});e.append(o.render().$el,s.render().$el),f.deselectAll(),r.deselectAll().select(t)})},initialize:function(){this.currentView=null,this.contentElement=n("#content")},removeCurrentView:function(){this.currentView&&(this.currentView.remove(),this.currentView=void 0)}}),u.MenuList=i.View.extend({itemTemplate:t('<li><a href="<%= url %>"><%= text %><\/a><\/li>').template(),emptyItem:"<li>no event exists.<\/li>",setEvents:function(n){return this.events=n,this},render:function(){var i=this.options.prefix,r=this.itemTemplate,n="";return this.events.length?t(this.events).each(function(t){n+=r({url:f(i,t),text:t})}):n=this.emptyItem,this.el.innerHTML=n,this},select:function(n){var t=this.$el.find("li").find('a:contains("'+n+'")');return t.parent("li").addClass("active"),this},deselectAll:function(){return this.$el.find("li.active").removeClass("active"),this}}),u.TimeframeList=i.View.extend({tagName:"dl",className:"sub-nav",template:t('<dd class="<%= (current) ? "active" : "" %>"><a href="<%= url %>"><%= text %><\/a><\/dd>').template(),render:function(){var i=this.template,r=this.options.label||"Timeframe:",u=(this.options.selectedTimeframe||"").toLowerCase(),e=this.options.urlPrefix,n="<dt>"+r+"<\/dt>";return t(this.options.timeframes).each(function(t){var r=u===t.toLowerCase();n+=i({text:t,url:f(e,t.toLowerCase()),current:r})}),this.el.innerHTML=n,this}}),u.MessageBox=i.View.extend({render:function(){return this.el.innerHTML=this.options.message,this}}),u.EventActivityGraph=i.View.extend({maxHistory:7,className:"event-activity-graph",initialize:function(){u.eventActivityProxy.server.subscribe(this.options.eventName),this.listenTo(u.pubsub,"eventActivity:received",this.onDataReceive)},render:function(){return this.data={},this.chart=this.$el.plot([this.processData()],{series:{shadowSize:0,lines:{fill:!0,show:!0}},xaxis:{mode:"time",timeformat:this.getFormat()},yaxis:{min:0}}).data("plot"),this.chart.draw(),this},remove:function(){return u.eventActivityProxy.server.unsubscribe(this.options.eventName),i.View.prototype.remove.call(this),this},update:function(){var n=this.processData();this.chart.setData([n]),this.chart.setupGrid(),this.chart.draw()},processData:function(){for(var r=this.data,u=[],f=t(r).keys().sort(function(n,t){return parseInt(n,10)-parseInt(t,10)}),i,n=0,e=f.length;n<e;n++)i=f[n],u.push([parseInt(i,10),r[i]]);return u},getFormat:function(){var n=this.options.timeframe.toLowerCase();switch(n){case"second":return"%I:%M:%S%P";case"minute":return"%I:%M%P";case"hour":return"%I%P";case"day":return"%a";case"month":return"%b";case"year":return"%Y";default:throw new Error("Unknown timeframe!");}},onDataReceive:function(n){var i,u;this.options.eventName===n.eventName&&this.options.timeframe.toLowerCase()===n.timeframe.toLowerCase()&&(i={timestamp:r(n.timestamp).toDate().getTime(),count:n.count},t(this.data).has(i.timestamp)||(this.data[i.timestamp]=0),this.data[i.timestamp]+=i.count,t(this.data).keys().length>this.maxHistory&&(u=t(this.data).keys().sort(function(n,t){return parseInt(n,10)-parseInt(t,10)}),this.data=t(this.data).pick(t(u).rest())),this.update())}}),u.pubsub=t({}).extend(i.Events),u.eventActivityProxy=n.connection.eventActivityHub,u.eventActivityProxy.client.update=function(t){var i=n.parseJSON(t);u.pubsub.trigger("eventActivity:received",i)},u.userActivityProxy=n.connection.userActivityHub,u.userActivityProxy.client.update=function(n,t,i,r){var f={eventName:n,timeframe:t,timestamp:i,users:r};u.pubsub.trigger("userActivity:received",f)},u.userMenuList=new u.MenuList({el:"#user-activity-list",prefix:"user-activity"}),u.eventMenuList=new u.MenuList({el:"#event-activity-list",prefix:"event-activity"}),u.router=new u.Router,n.connection.hub.start().done(function(){u.userActivityProxy.server.eventNames().done(function(n){u.userMenuList.setEvents(n).render()}),u.eventActivityProxy.server.eventNames().done(function(n){u.eventMenuList.setEvents(n).render()}),i.history.start()}),n(function(){n(document).foundation()}),window.App=u})(jQuery,_,Backbone,moment);